# Recording Rules para PatoCash - Máquina 2
# Baseado nas regras funcionais do cluster Kubernetes
groups:
  - name: patocast_hpa_demo
    interval: 5s
    rules:
      # Recording rules - queries pré-calculadas
      - record: patocast:cpu_usage_percent
        expr: avg(rate(process_cpu_seconds_total{app="patocast-backend"}[1m]) * 100) by (instance)
        labels:
          description: "Porcentagem de uso de CPU por instância do backend PatoCash"

      - record: patocast:pod_count
        expr: count(kube_pod_info{pod=~"patocast-backend.*"})
        labels:
          description: "Número total de pods do backend PatoCash em execução"

      - record: patocast:hpa_current_replicas
        expr: kube_horizontalpodautoscaler_status_current_replicas{horizontalpodautoscaler="patocast-backend-hpa"}
        labels:
          description: "Número atual de réplicas configuradas pelo HPA do backend PatoCash"

      - record: patocast:hpa_desired_replicas
        expr: kube_horizontalpodautoscaler_status_desired_replicas{horizontalpodautoscaler="patocast-backend-hpa"}
        labels:
          description: "Número desejado de réplicas pelo HPA do backend PatoCash"

      - record: patocast:cpu_above_threshold
        expr: avg(rate(process_cpu_seconds_total{app="patocast-backend"}[1m]) * 100) by (instance)
        labels:
          description: "Uso de CPU por instância do backend PatoCash (para comparação com threshold)"

      - record: patocast:replica_changes
        expr: delta(kube_deployment_status_replicas_available{deployment="patocast-backend"}[1m])
        labels:
          description: "Mudanças no número de réplicas disponíveis do deployment backend no último minuto"

      - record: patocast:avg_cpu_usage
        expr: avg(rate(process_cpu_seconds_total{app="patocast-backend"}[1m]) * 100)
        labels:
          description: "Uso médio de CPU do backend PatoCash"